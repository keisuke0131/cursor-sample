# サンプルシステム設計書：社員管理システム

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 社員管理システム 詳細設計書 |
| バージョン | 1.0 |
| 作成日 | 2025-12-01 |
| 作成者 | [作成者名] |
| 承認者 | [承認者名] |

---

## 2. 概要

### 2.1 目的
社員情報を管理する簡易な社内システムを開発します。
社員の登録、検索、更新、削除の基本機能を提供します。

### 2.2 対象範囲
- 社員情報のCRUD操作
- 社員情報の検索機能
- 部署情報の管理

### 2.3 前提条件
- Java 17以上
- Spring Boot 3.x
- Maven 3.8以上
- H2 Database（開発環境）

---

## 3. システム構成

### 3.1 アーキテクチャ
```
[EmployeeController] (REST API)
    ↓
[EmployeeService] (ビジネスロジック)
    ↓
[EmployeeRepository] (データアクセス)
    ↓
[H2 Database]
```

### 3.2 技術スタック
- フレームワーク: Spring Boot 3.2.0
- ビルドツール: Maven
- データベース: H2 Database 2.2.224
- テストフレームワーク: JUnit 5.10.0, Mockito 5.7.0

---

## 4. 機能設計

### 4.1 機能一覧
| No | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| 1 | 社員登録 | 新しい社員を登録する | 高 |
| 2 | 社員一覧取得 | 登録されている社員の一覧を取得する | 高 |
| 3 | 社員詳細取得 | 指定したIDの社員情報を取得する | 高 |
| 4 | 社員更新 | 既存の社員情報を更新する | 高 |
| 5 | 社員削除 | 社員情報を削除する（論理削除） | 高 |
| 6 | 社員検索 | 名前や部署で社員を検索する | 中 |
| 7 | 部署一覧取得 | 部署の一覧を取得する | 中 |

### 4.2 機能詳細

#### 4.2.1 社員登録

##### 概要
新しい社員をシステムに登録します。

##### 処理フロー
```
1. リクエストパラメータのバリデーション
2. メールアドレスの重複チェック
3. 社員番号の自動採番
4. 社員情報をデータベースに保存
5. 登録された社員情報を返却
```

##### 入力
- リクエストパラメータ
  - `name`: String（必須、1-100文字） - 社員名
  - `email`: String（必須、メール形式） - メールアドレス
  - `departmentId`: Long（必須） - 部署ID
  - `joinDate`: LocalDate（必須） - 入社日

##### 出力
- レスポンス
  - `id`: Long - 社員ID
  - `employeeNumber`: String - 社員番号
  - `name`: String - 社員名
  - `email`: String - メールアドレス
  - `department`: DepartmentDto - 部署情報
  - `joinDate`: LocalDate - 入社日
  - `createdAt`: LocalDateTime - 作成日時

##### エラーハンドリング
| エラーコード | エラーメッセージ | 発生条件 |
|-------------|-----------------|---------|
| ERR001 | メールアドレスが重複しています | 既に登録されているメールアドレス |
| ERR002 | 部署が存在しません | 存在しない部署ID |
| ERR003 | バリデーションエラー | リクエストパラメータが不正 |

#### 4.2.2 社員一覧取得

##### 概要
登録されている社員の一覧を取得します。ページネーションに対応しています。

##### 処理フロー
```
1. ページネーションパラメータの取得
2. データベースから社員一覧を取得
3. ページネーション情報と共に返却
```

##### 入力
- クエリパラメータ
  - `page`: Integer（デフォルト: 0） - ページ番号
  - `size`: Integer（デフォルト: 20） - 1ページあたりの件数
  - `name`: String（任意） - 名前で検索
  - `departmentId`: Long（任意） - 部署IDで検索

##### 出力
- レスポンス
  - `content`: List<EmployeeDto> - 社員リスト
  - `totalElements`: Long - 総件数
  - `totalPages`: Integer - 総ページ数
  - `currentPage`: Integer - 現在のページ

#### 4.2.3 社員詳細取得

##### 概要
指定したIDの社員情報を取得します。

##### 処理フロー
```
1. IDで社員を検索
2. 存在しない場合は404エラー
3. 社員情報を返却
```

##### 入力
- パスパラメータ
  - `id`: Long - 社員ID

##### 出力
- レスポンス: EmployeeDto

##### エラーハンドリング
| エラーコード | エラーメッセージ | 発生条件 |
|-------------|-----------------|---------|
| ERR004 | 社員が見つかりません | 存在しない社員ID |

#### 4.2.4 社員更新

##### 概要
既存の社員情報を更新します。

##### 処理フロー
```
1. IDで社員を検索
2. 存在しない場合は404エラー
3. リクエストパラメータのバリデーション
4. メールアドレスの重複チェック（変更時）
5. 社員情報を更新
6. 更新された社員情報を返却
```

##### 入力
- パスパラメータ
  - `id`: Long - 社員ID
- リクエストボディ
  - `name`: String（任意、1-100文字） - 社員名
  - `email`: String（任意、メール形式） - メールアドレス
  - `departmentId`: Long（任意） - 部署ID

##### 出力
- レスポンス: EmployeeDto

#### 4.2.5 社員削除

##### 概要
社員情報を論理削除します。

##### 処理フロー
```
1. IDで社員を検索
2. 存在しない場合は404エラー
3. 削除日時を設定（論理削除）
4. 204 No Contentを返却
```

##### 入力
- パスパラメータ
  - `id`: Long - 社員ID

##### 出力
- ステータスコード: 204 No Content

---

## 5. データベース設計

### 5.1 ER図
```
[Department] --< [Employee]
```

### 5.2 テーブル定義

#### 5.2.1 employees テーブル
| カラム名 | データ型 | NULL | 主キー | 説明 |
|---------|---------|------|--------|------|
| id | BIGINT | NO | PK | 社員ID |
| employee_number | VARCHAR(20) | NO | UNIQUE | 社員番号 |
| name | VARCHAR(100) | NO | | 社員名 |
| email | VARCHAR(255) | NO | UNIQUE | メールアドレス |
| department_id | BIGINT | NO | FK | 部署ID |
| join_date | DATE | NO | | 入社日 |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |
| deleted_at | TIMESTAMP | YES | | 削除日時（論理削除用） |

#### 5.2.2 departments テーブル
| カラム名 | データ型 | NULL | 主キー | 説明 |
|---------|---------|------|--------|------|
| id | BIGINT | NO | PK | 部署ID |
| name | VARCHAR(100) | NO | UNIQUE | 部署名 |
| code | VARCHAR(20) | NO | UNIQUE | 部署コード |
| created_at | TIMESTAMP | NO | | 作成日時 |
| updated_at | TIMESTAMP | NO | | 更新日時 |

#### 5.2.3 インデックス
| インデックス名 | テーブル | カラム | 種類 |
|--------------|---------|--------|------|
| idx_employee_email | employees | email | UNIQUE |
| idx_employee_number | employees | employee_number | UNIQUE |
| idx_employee_department | employees | department_id | INDEX |
| idx_employee_name | employees | name | INDEX |
| idx_department_code | departments | code | UNIQUE |

#### 5.2.4 外部キー制約
| 制約名 | 参照元テーブル | 参照先テーブル | カラム |
|--------|---------------|---------------|--------|
| fk_employee_department | employees | departments | department_id |

### 5.3 初期データ

#### 5.3.1 departments テーブル
```sql
INSERT INTO departments (id, name, code, created_at, updated_at) VALUES
(1, '営業部', 'SALES', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
(2, '開発部', 'DEV', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
(3, '人事部', 'HR', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);
```

---

## 6. API設計

### 6.1 REST APIエンドポイント一覧
| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| GET | /api/v1/employees | 社員一覧取得 | 不要 |
| GET | /api/v1/employees/{id} | 社員詳細取得 | 不要 |
| POST | /api/v1/employees | 社員作成 | 不要 |
| PUT | /api/v1/employees/{id} | 社員更新 | 不要 |
| DELETE | /api/v1/employees/{id} | 社員削除 | 不要 |
| GET | /api/v1/departments | 部署一覧取得 | 不要 |

### 6.2 API詳細

#### 6.2.1 GET /api/v1/employees
##### 説明
社員一覧を取得します。

##### リクエスト
- クエリパラメータ
  - `page`: Integer（デフォルト: 0）
  - `size`: Integer（デフォルト: 20）
  - `name`: String（任意）
  - `departmentId`: Long（任意）

##### レスポンス
```json
{
  "content": [
    {
      "id": 1,
      "employeeNumber": "EMP001",
      "name": "山田太郎",
      "email": "yamada@example.com",
      "department": {
        "id": 1,
        "name": "営業部",
        "code": "SALES"
      },
      "joinDate": "2025-12-01",
      "createdAt": "2025-12-01T00:00:00"
    }
  ],
  "totalElements": 100,
  "totalPages": 5,
  "currentPage": 0
}
```

##### ステータスコード
- 200 OK: 正常終了

#### 6.2.2 POST /api/v1/employees
##### 説明
新しい社員を作成します。

##### リクエスト
```json
{
  "name": "山田太郎",
  "email": "yamada@example.com",
  "departmentId": 1,
  "joinDate": "2025-12-01"
}
```

##### レスポンス
```json
{
  "id": 1,
  "employeeNumber": "EMP001",
  "name": "山田太郎",
  "email": "yamada@example.com",
  "department": {
    "id": 1,
    "name": "営業部",
    "code": "SALES"
  },
  "joinDate": "2025-12-01",
  "createdAt": "2025-12-01T00:00:00"
}
```

##### ステータスコード
- 201 Created: 作成成功
- 400 Bad Request: バリデーションエラー
- 409 Conflict: メールアドレス重複

---

## 7. クラス設計

### 7.1 クラス一覧
| クラス名 | パッケージ | 説明 |
|---------|-----------|------|
| EmployeeController | com.company.system.controller | 社員コントローラー |
| EmployeeService | com.company.system.service | 社員サービス |
| EmployeeRepository | com.company.system.repository | 社員リポジトリ |
| Employee | com.company.system.model | 社員エンティティ |
| EmployeeDto | com.company.system.dto | 社員DTO |
| DepartmentController | com.company.system.controller | 部署コントローラー |
| DepartmentService | com.company.system.service | 部署サービス |
| DepartmentRepository | com.company.system.repository | 部署リポジトリ |
| Department | com.company.system.model | 部署エンティティ |
| DepartmentDto | com.company.system.dto | 部署DTO |

### 7.2 クラス詳細

#### 7.2.1 EmployeeController
##### 責務
- HTTPリクエストの受け取り
- リクエストパラメータのバリデーション
- レスポンスの返却

##### メソッド一覧
| メソッド名 | HTTPメソッド | パス | 戻り値 |
|-----------|------------|------|--------|
| getEmployees | GET | /api/v1/employees | ResponseEntity<Page<EmployeeDto>> |
| getEmployee | GET | /api/v1/employees/{id} | ResponseEntity<EmployeeDto> |
| createEmployee | POST | /api/v1/employees | ResponseEntity<EmployeeDto> |
| updateEmployee | PUT | /api/v1/employees/{id} | ResponseEntity<EmployeeDto> |
| deleteEmployee | DELETE | /api/v1/employees/{id} | ResponseEntity<Void> |

#### 7.2.2 EmployeeService
##### 責務
- ビジネスロジックの実装
- トランザクション管理
- 社員番号の自動採番

##### メソッド一覧
| メソッド名 | 戻り値 | 説明 |
|-----------|--------|------|
| findAll | Page<EmployeeDto> | 社員一覧取得（ページネーション対応） |
| findById | EmployeeDto | IDで社員取得 |
| create | EmployeeDto | 社員作成 |
| update | EmployeeDto | 社員更新 |
| delete | void | 社員削除（論理削除） |

##### ビジネスルール
- 社員番号は自動採番（形式: EMP001, EMP002, ...）
- メールアドレスは重複不可
- 削除時は論理削除を実施（deleted_atを設定）
- 検索時は削除されていない社員のみ取得

#### 7.2.3 EmployeeRepository
##### 責務
- データベースアクセス
- CRUD操作の実装
- カスタムクエリの定義

##### メソッド一覧
| メソッド名 | 戻り値 | 説明 |
|-----------|--------|------|
| findAll | Page<Employee> | 全社員取得（ページネーション対応） |
| findById | Optional<Employee> | IDで社員取得 |
| findByEmail | Optional<Employee> | メールアドレスで社員取得 |
| findByEmployeeNumber | Optional<Employee> | 社員番号で社員取得 |
| save | Employee | 社員保存 |
| delete | void | 社員削除 |

##### カスタムクエリ
```java
@Query("SELECT e FROM Employee e WHERE e.deletedAt IS NULL " +
       "AND (:name IS NULL OR e.name LIKE %:name%) " +
       "AND (:departmentId IS NULL OR e.department.id = :departmentId)")
Page<Employee> findByConditions(@Param("name") String name,
                                 @Param("departmentId") Long departmentId,
                                 Pageable pageable);
```

#### 7.2.4 Employee（Entity）
##### 属性
| 属性名 | 型 | 説明 |
|--------|-----|------|
| id | Long | 社員ID |
| employeeNumber | String | 社員番号 |
| name | String | 社員名 |
| email | String | メールアドレス |
| department | Department | 部署（ManyToOne） |
| joinDate | LocalDate | 入社日 |
| createdAt | LocalDateTime | 作成日時 |
| updatedAt | LocalDateTime | 更新日時 |
| deletedAt | LocalDateTime | 削除日時（論理削除用） |

#### 7.2.5 EmployeeDto
##### 属性
| 属性名 | 型 | 説明 |
|--------|-----|------|
| id | Long | 社員ID |
| employeeNumber | String | 社員番号 |
| name | String | 社員名 |
| email | String | メールアドレス |
| department | DepartmentDto | 部署情報 |
| joinDate | LocalDate | 入社日 |
| createdAt | LocalDateTime | 作成日時 |

---

## 8. 例外設計

### 8.1 例外クラス一覧
| 例外クラス名 | 説明 | HTTPステータス |
|------------|------|---------------|
| ResourceNotFoundException | リソースが見つからない | 404 Not Found |
| ValidationException | バリデーションエラー | 400 Bad Request |
| DuplicateResourceException | 重複エラー | 409 Conflict |
| InternalServerException | サーバーエラー | 500 Internal Server Error |

### 8.2 例外処理フロー
```
[Controller]
    ↓ 例外発生
[@ExceptionHandler]
    ↓
[ErrorResponse生成]
    ↓
[HTTPレスポンス返却]
```

### 8.3 エラーレスポンス形式
```json
{
  "errorCode": "ERR001",
  "message": "メールアドレスが重複しています",
  "timestamp": "2025-12-01T00:00:00"
}
```

---

## 9. 実装順序

1. データベーステーブル作成（schema.sql）
2. 初期データ投入（data.sql）
3. Departmentエンティティ・Repository実装
4. Employeeエンティティ・Repository実装
5. DepartmentService・Controller実装
6. EmployeeService実装
7. EmployeeController実装
8. DTOクラス実装
9. 例外クラス・ExceptionHandler実装
10. 単体テスト実装
11. 結合テスト実装
12. システムテスト実装

---

## 10. Cursorでの実装例

### 10.1 エンティティの実装
```
@docs/05_サンプルシステム設計書.md のEmployeeエンティティを実装してください。
パッケージは com.company.system.model です。
JPAアノテーションを使用してください。
```

### 10.2 サービスの実装
```
@docs/05_サンプルシステム設計書.md のEmployeeServiceを実装してください。
社員番号の自動採番ロジックを含めてください。
```

### 10.3 コントローラーの実装
```
@docs/05_サンプルシステム設計書.md のEmployeeControllerを実装してください。
RESTful APIのエンドポイントを定義してください。
```

### 10.4 テストの実装
```
@docs/04_テスト設計書.md のテストケースを実装してください。
JUnit 5とMockitoを使用してください。
```

---

## 11. 変更履歴

| バージョン | 変更日 | 変更内容 | 変更者 |
|-----------|--------|---------|--------|
| 1.0 | 2025-12-01 | 初版作成 | [作成者名] |

