# テスト設計書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | テスト設計書 |
| バージョン | 1.0 |
| 作成日 | YYYY-MM-DD |
| 作成者 | [作成者名] |

---

## 2. 概要

### 2.1 目的
本ドキュメントでは、Javaアプリケーションのテスト設計について説明します。
単体テスト、結合テスト、システムテストの各フェーズにおけるテスト方針、テストケース、テストデータを定義します。

### 2.2 テスト対象
- アプリケーション全体
- 各レイヤー（Controller、Service、Repository）

### 2.3 テストツール
- **単体テスト**: JUnit 5
- **モック**: Mockito
- **結合テスト**: Spring Boot Test
- **データベース**: H2 Database（テスト用）

---

## 3. テスト方針

### 3.1 テストレベル
1. **単体テスト**: クラス・メソッド単位のテスト
2. **結合テスト**: 複数クラス間の連携テスト
3. **システムテスト**: エンドツーエンドのテスト

### 3.2 テストカバレッジ目標
- 単体テスト: 80%以上
- 結合テスト: 主要なシナリオを網羅
- システムテスト: 主要なユースケースを網羅

### 3.3 テストデータ管理
- テストデータは各テストクラス内で定義
- テスト実行前にデータをセットアップ
- テスト実行後にデータをクリーンアップ

---

## 4. 単体テスト設計

### 4.1 テスト対象
各クラスのメソッドを個別にテストします。

### 4.2 テスト方針
- モックを使用して依存関係を排除
- 正常系・異常系の両方をテスト
- 境界値テストを実施

### 4.3 テストケース例

#### 4.3.1 UserService テストケース

##### テストクラス: UserServiceTest
**パッケージ**: `com.company.system.unit`

| No | テストケース名 | テスト内容 | 期待結果 |
|----|---------------|-----------|---------|
| UT-001 | findAll_正常系 | 全ユーザーを取得 | ユーザーリストが返却される |
| UT-002 | findById_正常系 | 存在するIDでユーザー取得 | ユーザーが返却される |
| UT-003 | findById_異常系 | 存在しないIDでユーザー取得 | ResourceNotFoundExceptionが発生 |
| UT-004 | create_正常系 | 新しいユーザーを作成 | ユーザーが作成される |
| UT-005 | create_異常系_メール重複 | 重複するメールアドレスで作成 | DuplicateResourceExceptionが発生 |
| UT-006 | create_異常系_バリデーションエラー | 無効なパラメータで作成 | ValidationExceptionが発生 |
| UT-007 | update_正常系 | 既存ユーザーを更新 | ユーザーが更新される |
| UT-008 | update_異常系_存在しないID | 存在しないIDで更新 | ResourceNotFoundExceptionが発生 |
| UT-009 | delete_正常系 | 既存ユーザーを削除 | ユーザーが削除される |
| UT-010 | delete_異常系_存在しないID | 存在しないIDで削除 | ResourceNotFoundExceptionが発生 |

##### テストデータ
```java
// 正常系テストデータ
User user1 = new User(1L, "山田太郎", "yamada@example.com", "password123");
User user2 = new User(2L, "佐藤花子", "sato@example.com", "password456");

// 異常系テストデータ
Long nonExistentId = 999L;
String duplicateEmail = "yamada@example.com";
```

##### モック設定例
```java
@Mock
private UserRepository userRepository;

@InjectMocks
private UserService userService;

@BeforeEach
void setUp() {
    MockitoAnnotations.openMocks(this);
}
```

#### 4.3.2 UserController テストケース

##### テストクラス: UserControllerTest
**パッケージ**: `com.company.system.unit`

| No | テストケース名 | テスト内容 | 期待結果 |
|----|---------------|-----------|---------|
| UT-011 | getUsers_正常系 | ユーザー一覧取得API | 200 OK、ユーザーリストが返却 |
| UT-012 | getUser_正常系 | ユーザー詳細取得API | 200 OK、ユーザーが返却 |
| UT-013 | getUser_異常系 | 存在しないIDで取得 | 404 Not Found |
| UT-014 | createUser_正常系 | ユーザー作成API | 201 Created、ユーザーが作成 |
| UT-015 | createUser_異常系_バリデーション | 無効なリクエスト | 400 Bad Request |
| UT-016 | updateUser_正常系 | ユーザー更新API | 200 OK、ユーザーが更新 |
| UT-017 | deleteUser_正常系 | ユーザー削除API | 204 No Content |

##### テストデータ
```java
// リクエストボディ
CreateUserRequest request = new CreateUserRequest(
    "山田太郎",
    "yamada@example.com",
    "password123"
);

// レスポンス期待値
UserDto expectedDto = new UserDto(1L, "山田太郎", "yamada@example.com");
```

#### 4.3.3 UserRepository テストケース

##### テストクラス: UserRepositoryTest
**パッケージ**: `com.company.system.unit`

| No | テストケース名 | テスト内容 | 期待結果 |
|----|---------------|-----------|---------|
| UT-018 | save_正常系 | ユーザーを保存 | ユーザーが保存される |
| UT-019 | findById_正常系 | IDでユーザー取得 | ユーザーが取得される |
| UT-020 | findById_異常系 | 存在しないIDで取得 | Optional.empty()が返却 |
| UT-021 | findByEmail_正常系 | メールアドレスで取得 | ユーザーが取得される |
| UT-022 | findAll_正常系 | 全ユーザー取得 | ユーザーリストが取得される |
| UT-023 | delete_正常系 | ユーザー削除 | ユーザーが削除される |

---

## 5. 結合テスト設計

### 5.1 テスト対象
複数のクラスが連携して動作することを確認します。

### 5.2 テスト方針
- 実際のデータベースを使用（H2 Database）
- トランザクションの動作確認
- サービス層とリポジトリ層の連携確認

### 5.3 テストケース例

#### 5.3.1 UserServiceとUserRepositoryの結合テスト

##### テストクラス: UserServiceIntegrationTest
**パッケージ**: `com.company.system.integration`

| No | テストケース名 | テスト内容 | 期待結果 |
|----|---------------|-----------|---------|
| IT-001 | createAndFind_正常系 | ユーザー作成後、取得 | 作成したユーザーが取得できる |
| IT-002 | update_正常系 | ユーザー更新後、取得 | 更新内容が反映されている |
| IT-003 | delete_正常系 | ユーザー削除後、取得 | ユーザーが取得できない |
| IT-004 | transaction_ロールバック | トランザクション内でエラー発生 | ロールバックされる |
| IT-005 | findByEmail_正常系 | メールアドレスで検索 | 正しいユーザーが取得できる |

##### テストデータセットアップ
```java
@SpringBootTest
@Transactional
class UserServiceIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRepository userRepository;
    
    @BeforeEach
    void setUp() {
        // テストデータのセットアップ
        User user = new User("テストユーザー", "test@example.com", "password");
        userRepository.save(user);
    }
    
    @AfterEach
    void tearDown() {
        // テストデータのクリーンアップ
        userRepository.deleteAll();
    }
}
```

#### 5.3.2 ControllerとServiceの結合テスト

##### テストクラス: UserControllerIntegrationTest
**パッケージ**: `com.company.system.integration`

| No | テストケース名 | テスト内容 | 期待結果 |
|----|---------------|-----------|---------|
| IT-006 | createUser_正常系 | ユーザー作成API呼び出し | 201 Created、DBに保存される |
| IT-007 | getUser_正常系 | ユーザー取得API呼び出し | 200 OK、正しいデータが返却 |
| IT-008 | updateUser_正常系 | ユーザー更新API呼び出し | 200 OK、DBが更新される |
| IT-009 | deleteUser_正常系 | ユーザー削除API呼び出し | 204 No Content、DBから削除 |

##### テスト実装例
```java
@SpringBootTest
@AutoConfigureMockMvc
@Transactional
class UserControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void createUser_正常系() throws Exception {
        CreateUserRequest request = new CreateUserRequest(
            "山田太郎",
            "yamada@example.com",
            "password123"
        );
        
        mockMvc.perform(post("/api/v1/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.name").value("山田太郎"));
        
        // DBに保存されていることを確認
        Optional<User> savedUser = userRepository.findByEmail("yamada@example.com");
        assertTrue(savedUser.isPresent());
    }
}
```

---

## 6. システムテスト設計

### 6.1 テスト対象
エンドツーエンドの動作を確認します。

### 6.2 テスト方針
- 実際のアプリケーションを起動してテスト
- 実際のHTTPリクエストを送信
- 実際のデータベースを使用

### 6.3 テストシナリオ

#### 6.3.1 ユーザー管理シナリオ

##### シナリオ1: ユーザー作成から削除までの一連の流れ
| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 1 | POST /api/v1/users でユーザー作成 | 201 Created、ユーザーが作成される |
| 2 | GET /api/v1/users/{id} でユーザー取得 | 200 OK、作成したユーザーが取得できる |
| 3 | GET /api/v1/users でユーザー一覧取得 | 200 OK、作成したユーザーが含まれる |
| 4 | PUT /api/v1/users/{id} でユーザー更新 | 200 OK、ユーザーが更新される |
| 5 | DELETE /api/v1/users/{id} でユーザー削除 | 204 No Content、ユーザーが削除される |
| 6 | GET /api/v1/users/{id} でユーザー取得 | 404 Not Found |

##### テストクラス: UserSystemTest
**パッケージ**: `com.company.system.system`

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class UserSystemTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void ユーザー作成から削除までの一連の流れ() {
        // 1. ユーザー作成
        CreateUserRequest createRequest = new CreateUserRequest(
            "システムテストユーザー",
            "systemtest@example.com",
            "password123"
        );
        
        ResponseEntity<UserDto> createResponse = restTemplate.postForEntity(
            "/api/v1/users",
            createRequest,
            UserDto.class
        );
        
        assertEquals(HttpStatus.CREATED, createResponse.getStatusCode());
        Long userId = createResponse.getBody().getId();
        
        // 2. ユーザー取得
        ResponseEntity<UserDto> getResponse = restTemplate.getForEntity(
            "/api/v1/users/" + userId,
            UserDto.class
        );
        
        assertEquals(HttpStatus.OK, getResponse.getStatusCode());
        assertEquals("システムテストユーザー", getResponse.getBody().getName());
        
        // 3. ユーザー更新
        UpdateUserRequest updateRequest = new UpdateUserRequest(
            "更新されたユーザー名",
            "updated@example.com"
        );
        
        restTemplate.put("/api/v1/users/" + userId, updateRequest);
        
        // 4. 更新確認
        ResponseEntity<UserDto> updatedResponse = restTemplate.getForEntity(
            "/api/v1/users/" + userId,
            UserDto.class
        );
        
        assertEquals("更新されたユーザー名", updatedResponse.getBody().getName());
        
        // 5. ユーザー削除
        restTemplate.delete("/api/v1/users/" + userId);
        
        // 6. 削除確認
        ResponseEntity<UserDto> deletedResponse = restTemplate.getForEntity(
            "/api/v1/users/" + userId,
            UserDto.class
        );
        
        assertEquals(HttpStatus.NOT_FOUND, deletedResponse.getStatusCode());
    }
}
```

#### 6.3.2 エラーハンドリングシナリオ

##### シナリオ2: エラーケースの確認
| ステップ | 操作 | 期待結果 |
|---------|------|---------|
| 1 | 存在しないIDでユーザー取得 | 404 Not Found |
| 2 | 無効なリクエストでユーザー作成 | 400 Bad Request |
| 3 | 重複するメールアドレスでユーザー作成 | 409 Conflict |

---

## 7. テストデータ設計

### 7.1 テストデータ一覧

#### 7.1.1 正常系テストデータ
| ID | 名前 | メールアドレス | パスワード |
|----|------|---------------|-----------|
| 1 | 山田太郎 | yamada@example.com | password123 |
| 2 | 佐藤花子 | sato@example.com | password456 |
| 3 | 鈴木一郎 | suzuki@example.com | password789 |

#### 7.1.2 異常系テストデータ
| ケース | データ | 理由 |
|--------|--------|------|
| 空文字 | name: "" | バリデーションエラー |
| 長すぎる文字列 | name: "a" × 101 | バリデーションエラー |
| 無効なメール形式 | email: "invalid-email" | バリデーションエラー |
| 重複メール | email: "yamada@example.com" | 重複エラー |
| 存在しないID | id: 999 | リソース未存在エラー |

### 7.2 テストデータ管理方法
- 各テストクラスの`@BeforeEach`でセットアップ
- 各テストクラスの`@AfterEach`でクリーンアップ
- `@Sql`アノテーションでSQLファイルを読み込み可能

---

## 8. テスト実行方法

### 8.1 単体テストの実行
```bash
# すべての単体テストを実行
mvn test

# 特定のテストクラスを実行
mvn test -Dtest=UserServiceTest

# カバレッジレポートを生成
mvn test jacoco:report
```

### 8.2 結合テストの実行
```bash
# 結合テストのみ実行
mvn test -Dtest=*IntegrationTest
```

### 8.3 システムテストの実行
```bash
# システムテストのみ実行
mvn test -Dtest=*SystemTest
```

### 8.4 すべてのテストを実行
```bash
# すべてのテストを実行
mvn clean test
```

---

## 9. テストカバレッジ

### 9.1 カバレッジ目標
- 全体: 80%以上
- ビジネスロジック（Service層）: 90%以上
- データアクセス（Repository層）: 85%以上

### 9.2 カバレッジレポート確認
```bash
# カバレッジレポートを生成
mvn test jacoco:report

# レポートを確認
open target/site/jacoco/index.html
```

---

## 10. Cursorでのテスト作成方法

### 10.1 単体テストの作成
```
@src/main/java/com/company/system/service/UserService.java の
単体テストを作成してください。
JUnit 5とMockitoを使用し、正常系・異常系のテストケースを含めてください。
```

### 10.2 結合テストの作成
```
@src/main/java/com/company/system/service/UserService.java と
@src/main/java/com/company/system/repository/UserRepository.java の
結合テストを作成してください。
H2 Databaseを使用して、実際のデータベース操作をテストしてください。
```

### 10.3 システムテストの作成
```
REST APIのエンドツーエンドテストを作成してください。
Spring Boot Testを使用して、実際のアプリケーションを起動してテストしてください。
```

---

## 11. テストチェックリスト

### 単体テスト
- [ ] すべてのメソッドにテストが存在する
- [ ] 正常系・異常系の両方をテストしている
- [ ] 境界値テストを実施している
- [ ] モックを適切に使用している
- [ ] テストが独立して実行できる

### 結合テスト
- [ ] 主要なシナリオを網羅している
- [ ] トランザクションの動作を確認している
- [ ] データベースの操作を確認している
- [ ] テストデータのセットアップ・クリーンアップが適切

### システムテスト
- [ ] エンドツーエンドのシナリオをテストしている
- [ ] エラーハンドリングを確認している
- [ ] 実際のアプリケーションで動作確認している

---

## 12. 変更履歴

| バージョン | 変更日 | 変更内容 | 変更者 |
|-----------|--------|---------|--------|
| 1.0 | YYYY-MM-DD | 初版作成 | [作成者名] |

