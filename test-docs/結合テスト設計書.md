# 結合テスト設計書：社員管理システム

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 結合テスト設計書 |
| 対象システム | 社員管理システム |
| バージョン | 1.0 |
| 作成日 | 2025-12-01 |
| 作成者 | [作成者名] |
| 承認者 | [承認者名] |

---

## 2. 概要

### 2.1 目的
本ドキュメントでは、社員管理システムの結合テストのテストケース、テスト手順、期待結果を定義します。
結合テストでは、複数のクラスやレイヤーが連携して動作することを確認します。

### 2.2 テスト対象
- Service層とRepository層の連携
- Controller層とService層の連携
- データベースとの連携
- トランザクション処理

### 2.3 テスト環境
- アプリケーションサーバー: Spring Boot（ポート: 8080）
- データベース: H2 Database（インメモリ）
- テストツール: Postman、curl、またはブラウザ

---

## 3. テスト方針

### 3.1 テストレベル
- レイヤー間の連携テスト
- データベースとの結合テスト
- トランザクションの動作確認

### 3.2 テストデータ
- テスト実行前に初期データを投入
- 各テストケースは独立して実行可能
- テスト実行後はデータをクリーンアップ

---

## 4. テストケース

### 4.1 EmployeeServiceとEmployeeRepositoryの結合テスト

#### テストケース IT-001: 社員作成と取得の連携

##### テスト目的
社員を作成し、作成した社員を取得できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 部署データが登録されている（部署ID: 1）

##### テスト手順
1. 社員作成APIを呼び出す
   - メソッド: POST
   - URL: `http://localhost:8080/api/v1/employees`
   - リクエストボディ:
     ```json
     {
       "name": "山田太郎",
       "email": "yamada@example.com",
       "departmentId": 1,
       "joinDate": "2025-12-01"
     }
     ```

2. レスポンスを確認する
   - ステータスコード: 201 Created
   - レスポンスボディに社員情報が含まれている
   - 社員番号が自動採番されている（例: EMP001）
   - id、employeeNumber、name、email、department、joinDate、createdAtが含まれている

3. 作成した社員IDで社員取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/employees/{id}`

4. レスポンスを確認する
   - ステータスコード: 200 OK
   - 作成した社員情報が正しく返却される
   - すべての項目が正しく返却される

##### 期待結果
- 社員が正常に作成される
- 作成した社員が取得できる
- 社員番号が自動採番される
- データベースに正しく保存される

##### テストデータ
- 部署ID: 1（営業部）
- 社員名: 山田太郎
- メールアドレス: yamada@example.com
- 入社日: 2025-12-01

---

#### テストケース IT-002: 社員更新の連携

##### テスト目的
社員情報を更新し、更新内容が正しく反映されることを確認する。

##### 前提条件
- アプリケーションが起動している
- 社員データが登録されている（社員ID: 1）

##### テスト手順
1. 社員更新APIを呼び出す
   - メソッド: PUT
   - URL: `http://localhost:8080/api/v1/employees/1`
   - リクエストボディ:
     ```json
     {
       "name": "山田次郎",
       "email": "yamada2@example.com",
       "departmentId": 2
     }
     ```

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - 更新された社員情報が返却される

3. 更新した社員IDで社員取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/employees/1`

4. レスポンスを確認する
   - ステータスコード: 200 OK
   - 更新内容が反映されている
   - 更新された項目が正しく返却される

##### 期待結果
- 社員情報が正常に更新される
- 更新内容がデータベースに反映される
- 更新後の社員情報が正しく取得できる

##### テストデータ
- 社員ID: 1
- 更新後の社員名: 山田次郎
- 更新後のメールアドレス: yamada2@example.com
- 更新後の部署ID: 2

---

#### テストケース IT-003: 社員削除（論理削除）の連携

##### テスト目的
社員を論理削除し、削除後は取得できないことを確認する。

##### 前提条件
- アプリケーションが起動している
- 社員データが登録されている（社員ID: 1）

##### テスト手順
1. 社員削除APIを呼び出す
   - メソッド: DELETE
   - URL: `http://localhost:8080/api/v1/employees/1`

2. レスポンスを確認する
   - ステータスコード: 204 No Content

3. 削除した社員IDで社員取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/employees/1`

4. レスポンスを確認する
   - ステータスコード: 404 Not Found
   - エラーレスポンスが返却される
   - errorCode: ERR004
   - message: "社員が見つかりません"

5. 社員一覧取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/employees`

6. レスポンスを確認する
   - ステータスコード: 200 OK
   - 削除した社員が一覧に含まれていない

##### 期待結果
- 社員が論理削除される（deleted_atが設定される）
- 削除後は社員が取得できない
- 削除した社員は一覧に表示されない
- データベースから物理削除されていない

##### テストデータ
- 社員ID: 1

---

#### テストケース IT-004: トランザクションのロールバック確認

##### テスト目的
トランザクション内でエラーが発生した場合、ロールバックされることを確認する。

##### 前提条件
- アプリケーションが起動している
- 部署データが登録されている

##### テスト手順
1. 重複するメールアドレスで社員作成APIを呼び出す
   - メソッド: POST
   - URL: `http://localhost:8080/api/v1/employees`
   - リクエストボディ:
     ```json
     {
       "name": "山田太郎",
       "email": "yamada@example.com",
       "departmentId": 1,
       "joinDate": "2025-12-01"
     }
     ```

2. 同じメールアドレスで再度社員作成APIを呼び出す
   - メソッド: POST
   - URL: `http://localhost:8080/api/v1/employees`
   - リクエストボディ:
     ```json
     {
       "name": "佐藤花子",
       "email": "yamada@example.com",
       "departmentId": 1,
       "joinDate": "2025-12-01"
     }
     ```

3. レスポンスを確認する
   - ステータスコード: 409 Conflict
   - エラーレスポンスが返却される
   - errorCode: ERR001
   - message: "メールアドレスが重複しています"
   - timestampが含まれている

4. 社員一覧取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/employees`

5. レスポンスを確認する
   - ステータスコード: 200 OK
   - 最初の社員のみが存在する

##### 期待結果
- 重複エラーが発生する
- ステータスコード: 409 Conflict
- エラーレスポンスが返却される
  - errorCode: ERR001
  - message: "メールアドレスが重複しています"
- 2回目の社員作成は失敗する
- データベースに不整合が発生しない
- 最初の社員は正常に作成されている

##### テストデータ
- メールアドレス: yamada@example.com（重複）

---

#### テストケース IT-005: メールアドレスでの検索

##### テスト目的
メールアドレスで社員を検索できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 社員データが登録されている

##### テスト手順
1. 社員一覧取得APIを呼び出す（検索条件なし）
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/employees`

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - 社員一覧が返却される

3. 特定のメールアドレスを持つ社員が存在することを確認する

##### 期待結果
- 社員一覧が正常に取得できる
- 登録されている社員が含まれている

##### テストデータ
- 検索対象のメールアドレス: yamada@example.com

---

### 4.2 ControllerとServiceの結合テスト

#### テストケース IT-006: 社員作成APIの連携

##### テスト目的
Controller層とService層が正しく連携して社員を作成できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 部署データが登録されている

##### テスト手順
1. 社員作成APIを呼び出す
   - メソッド: POST
   - URL: `http://localhost:8080/api/v1/employees`
   - リクエストボディ:
     ```json
     {
       "name": "佐藤花子",
       "email": "sato@example.com",
       "departmentId": 1,
       "joinDate": "2025-12-01"
     }
     ```

2. レスポンスを確認する
   - ステータスコード: 201 Created
   - Content-Type: application/json
   - レスポンスボディに作成された社員情報が含まれている
   - id、employeeNumber、name、email、department、joinDate、createdAtが含まれている

3. データベースを直接確認する
   - H2 Consoleにアクセス: `http://localhost:8080/h2-console`
   - employeesテーブルを確認
   - 作成された社員が存在することを確認

##### 期待結果
- APIが正常に動作する
- データベースに正しく保存される
- レスポンスが正しい形式で返却される

##### テストデータ
- 社員名: 佐藤花子
- メールアドレス: sato@example.com
- 部署ID: 1
- 入社日: 2025-12-01

---

#### テストケース IT-007: 社員取得APIの連携

##### テスト目的
Controller層とService層が正しく連携して社員を取得できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 社員データが登録されている（社員ID: 1）

##### テスト手順
1. 社員取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/employees/1`

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - Content-Type: application/json
   - レスポンスボディに社員情報が含まれている
   - id、employeeNumber、name、email、department、joinDate、createdAtが含まれている
   - 部署情報も含まれている（department.id、department.name、department.code）

##### 期待結果
- APIが正常に動作する
- 正しい社員情報が返却される
- 部署情報も正しく含まれている

##### テストデータ
- 社員ID: 1

---

#### テストケース IT-008: 社員更新APIの連携

##### テスト目的
Controller層とService層が正しく連携して社員を更新できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 社員データが登録されている（社員ID: 1）

##### テスト手順
1. 社員更新APIを呼び出す
   - メソッド: PUT
   - URL: `http://localhost:8080/api/v1/employees/1`
   - リクエストボディ:
     ```json
     {
       "name": "更新された名前",
       "email": "updated@example.com"
     }
     ```

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - Content-Type: application/json
   - 更新された社員情報が返却される
   - 更新された項目が正しく返却される

3. データベースを直接確認する
   - employeesテーブルを確認
   - 更新内容が反映されていることを確認
   - updated_atが更新されていることを確認

##### 期待結果
- APIが正常に動作する
- データベースが正しく更新される
- レスポンスが正しい形式で返却される

##### テストデータ
- 社員ID: 1
- 更新後の名前: 更新された名前
- 更新後のメールアドレス: updated@example.com

---

#### テストケース IT-009: 社員削除APIの連携

##### テスト目的
Controller層とService層が正しく連携して社員を削除できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 社員データが登録されている（社員ID: 1）

##### テスト手順
1. 社員削除APIを呼び出す
   - メソッド: DELETE
   - URL: `http://localhost:8080/api/v1/employees/1`

2. レスポンスを確認する
   - ステータスコード: 204 No Content
   - レスポンスボディが空

3. データベースを直接確認する
   - employeesテーブルを確認
   - deleted_atが設定されていることを確認
   - 物理削除されていないことを確認

##### 期待結果
- APIが正常に動作する
- データベースで論理削除される（deleted_atが設定される）
- レスポンスが正しい形式で返却される

##### テストデータ
- 社員ID: 1

---

### 4.3 DepartmentServiceとDepartmentRepositoryの結合テスト

#### テストケース IT-010: 部署一覧取得の連携

##### テスト目的
部署一覧を取得し、データベースから正しく取得できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 部署データが登録されている

##### テスト手順
1. 部署一覧取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/departments`

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - レスポンスボディに部署一覧が含まれている
   - 各部署にid、name、codeが含まれている

3. データベースを直接確認する
   - departmentsテーブルを確認
   - 登録されている部署が存在することを確認

##### 期待結果
- 部署一覧が正常に取得できる
- データベースの部署データが正しく返却される
- レスポンスが正しい形式で返却される

##### テストデータ
- 部署ID: 1（営業部、SALES）
- 部署ID: 2（開発部、DEV）

---

#### テストケース IT-011: 部署詳細取得の連携

##### テスト目的
部署詳細を取得し、データベースから正しく取得できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 部署データが登録されている（部署ID: 1）

##### テスト手順
1. 部署詳細取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/departments/1`

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - レスポンスボディに部署情報が含まれている
   - id、name、codeが正しく返却される

3. データベースを直接確認する
   - departmentsテーブルを確認
   - 取得した部署IDのデータが存在することを確認

##### 期待結果
- 部署詳細が正常に取得できる
- データベースの部署データが正しく返却される
- レスポンスが正しい形式で返却される

##### テストデータ
- 部署ID: 1（営業部、SALES）

---

#### テストケース IT-012: 存在しない部署IDで部署取得

##### テスト目的
存在しない部署IDで部署を取得した場合、適切なエラーが返却されることを確認する。

##### 前提条件
- アプリケーションが起動している

##### テスト手順
1. 存在しない部署IDで部署取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/departments/999`

2. レスポンスを確認する
   - ステータスコード: 404 Not Found
   - エラーレスポンスが返却される
   - errorCode: ERR004
   - message: "部署が見つかりません"

##### 期待結果
- 404エラーが返却される
- エラーレスポンスが正しい形式で返却される
- エラーコードとメッセージが正しい

##### テストデータ
- 存在しない部署ID: 999

---

### 4.4 ControllerとServiceの結合テスト（部署）

#### テストケース IT-013: 部署一覧取得APIの連携

##### テスト目的
Controller層とService層が正しく連携して部署一覧を取得できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 部署データが登録されている

##### テスト手順
1. 部署一覧取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/departments`

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - レスポンスボディに部署一覧が含まれている
   - Content-Type: application/json

3. データベースを直接確認する
   - departmentsテーブルを確認
   - 登録されている部署が存在することを確認

##### 期待結果
- APIが正常に動作する
- データベースの部署データが正しく返却される
- レスポンスが正しい形式で返却される

##### テストデータ
- 部署ID: 1（営業部、SALES）
- 部署ID: 2（開発部、DEV）

---

#### テストケース IT-014: 部署詳細取得APIの連携

##### テスト目的
Controller層とService層が正しく連携して部署詳細を取得できることを確認する。

##### 前提条件
- アプリケーションが起動している
- 部署データが登録されている（部署ID: 1）

##### テスト手順
1. 部署詳細取得APIを呼び出す
   - メソッド: GET
   - URL: `http://localhost:8080/api/v1/departments/1`

2. レスポンスを確認する
   - ステータスコード: 200 OK
   - レスポンスボディに部署情報が含まれている
   - id、name、codeが正しく返却される

3. データベースを直接確認する
   - departmentsテーブルを確認
   - 取得した部署IDのデータが存在することを確認

##### 期待結果
- APIが正常に動作する
- データベースの部署データが正しく返却される
- レスポンスが正しい形式で返却される

##### テストデータ
- 部署ID: 1（営業部、SALES）

---

## 5. テスト実行手順

### 5.1 テスト環境の準備

1. アプリケーションを起動する
   ```bash
   mvn spring-boot:run
   ```

2. アプリケーションが正常に起動したことを確認する
   - ログにエラーが表示されていない
   - ポート8080でリッスンしている

3. H2 Consoleにアクセスしてデータベースを確認する
   - URL: `http://localhost:8080/h2-console`
   - JDBC URL: `jdbc:h2:mem:testdb`
   - ユーザー名: `sa`
   - パスワード: （空）

### 5.2 テスト実行

1. 各テストケースを順番に実行する
2. テスト結果を記録する
3. 不具合が発見された場合は、バグレポートを作成する

### 5.3 テスト完了後

1. テスト結果をまとめる
2. テストレポートを作成する
3. 不具合があれば修正を依頼する

---

## 6. テスト結果記録

### 6.1 テスト結果表

| テストケースID | テストケース名 | 実行日 | 実行者 | 結果 | 備考 |
|--------------|--------------|--------|--------|------|------|
| IT-001 | 社員作成と取得の連携 | | | | |
| IT-002 | 社員更新の連携 | | | | |
| IT-003 | 社員削除（論理削除）の連携 | | | | |
| IT-004 | トランザクションのロールバック確認 | | | | |
| IT-005 | メールアドレスでの検索 | | | | |
| IT-006 | 社員作成APIの連携 | | | | |
| IT-007 | 社員取得APIの連携 | | | | |
| IT-008 | 社員更新APIの連携 | | | | |
| IT-009 | 社員削除APIの連携 | | | | |
| IT-010 | 部署一覧取得の連携 | | | | |
| IT-011 | 部署詳細取得の連携 | | | | |
| IT-012 | 存在しない部署IDで部署取得 | | | | |
| IT-013 | 部署一覧取得APIの連携 | | | | |
| IT-014 | 部署詳細取得APIの連携 | | | | |

### 6.2 結果記号
- ✅ 合格（Pass）
- ❌ 不合格（Fail）
- ⚠️ 保留（Pending）
- ⏭️ スキップ（Skip）

---

## 7. 不具合管理

### 7.1 不具合発見時の対応

1. 不具合を再現する
2. 不具合の詳細を記録する
3. バグレポートを作成する
4. 開発チームに報告する

### 7.2 バグレポート項目

- バグID
- 発見日時
- 発見者
- テストケースID
- 不具合の概要
- 再現手順
- 期待結果
- 実際の結果
- 優先度
- ステータス

---

## 8. 変更履歴

| バージョン | 変更日 | 変更内容 | 変更者 |
|-----------|--------|---------|--------|
| 1.0 | 2025-12-01 | 初版作成 | [作成者名] |

